{% extends "search.html" %}
{% block search_results %}

<!-- General Result -->
<p id="top-statement" class="mzp-c-article-intro">
    Finding possible repositories for paper: <a href="{{ paper_url }}" target="_blank">'{{ title }}'</a>
</p>

<!-- Loading Spinner -->
<div id="loading-div" class="loader">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
</div>

<!-- Templates to Fill After Async Loading -->
<template id="result-repo-stats-template">
    <div style="margin-top: 10px;">
        <div style="display: inline;margin-right: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 .25a.75.75 0 01.673.418l1.882 3.815 4.21.612a.75.75 0 01.416 1.279l-3.046 2.97.719 4.192a.75.75 0 01-1.088.791L8 12.347l-3.766 1.98a.75.75 0 01-1.088-.79l.72-4.194L.818 6.374a.75.75 0 01.416-1.28l4.21-.611L7.327.668A.75.75 0 018 .25z"></path>
            </svg>
            <p style="display: inline;" class="star-count"></p>
        </div>
        <div style="display: inline;margin-right: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"></path>
            </svg>
            <p style="display: inline;" class="fork-count"></p>
        </div>
        <div style="display: inline;margin-right: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.679 7.932c.412-.621 1.242-1.75 2.366-2.717C5.175 4.242 6.527 3.5 8 3.5c1.473 0 2.824.742 3.955 1.715 1.124.967 1.954 2.096 2.366 2.717a.119.119 0 010 .136c-.412.621-1.242 1.75-2.366 2.717C10.825 11.758 9.473 12.5 8 12.5c-1.473 0-2.824-.742-3.955-1.715C2.92 9.818 2.09 8.69 1.679 8.068a.119.119 0 010-.136zM8 2c-1.981 0-3.67.992-4.933 2.078C1.797 5.169.88 6.423.43 7.1a1.619 1.619 0 000 1.798c.45.678 1.367 1.932 2.637 3.024C4.329 13.008 6.019 14 8 14c1.981 0 3.67-.992 4.933-2.078 1.27-1.091 2.187-2.345 2.637-3.023a1.619 1.619 0 000-1.798c-.45-.678-1.367-1.932-2.637-3.023C11.671 2.992 9.981 2 8 2zm0 8a2 2 0 100-4 2 2 0 000 4z"></path>
            </svg>
            <p style="display: inline;" class="watcher-count"></p>
        </div>
        <div style="margin-right: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.5 7a4.499 4.499 0 11-8.998 0A4.499 4.499 0 0111.5 7zm-.82 4.74a6 6 0 111.06-1.06l3.04 3.04a.75.75 0 11-1.06 1.06l-3.04-3.04z"></path>
            </svg>
            <p style="display: inline;margin-top: 10px;" class="query-details"></p>
        </div>
    </div>
</template>

<template id="best-match-template">
    <h2>Most Similar Repository</h2>
    <div class="mzp-c-card mzp-c-card-medium">
        <a href="" target="_blank" class="repo-link mzp-c-card-block-link">
            <div class="mzp-c-card-content">
                <h4 style="text-overflow: ellipsis;" class="repo-name mzp-c-card-title"></h4>
                <p class="repo-description mzp-c-card-desc"></p>
                <div class="repo-stats-container"></div>
            </div>
        </a>
    </div>
    <hr/>
</template>

<template id="repeat-repo-match-template">
    <section class="mzp-c-card">
        <a href="" target="_blank" class="repo-link mzp-c-card-block-link">
            <div class="mzp-c-card-content">
                <div style="text-overflow: ellipsis;overflow: hidden;white-space: nowrap;">
                    <h4 class="repo-name mzp-c-card-title"></h4>
                </div>
                <p class="repo-description mzp-c-card-desc"></p>
                <div class="repo-stats-container"></div>
            </div>
        </a>
    </section>
</template>

<!-- Loaded Content (Filled After Async Load) -->
<div id="loaded-content">
    <div id="best-match"></div>
    <div style="padding: 0;" class="mzp-l-content mzp-l-card-half">
        <h3 id="all-other-matches-header"></h3>
        <div id="all-other-matches"></div>
    </div>
</div>

<script>
    // Parse params
    let query = '{{ query }}';

    // Parse existing DOM
    let topStatement = document.querySelector('#top-statement');
    let loadingDiv = document.querySelector('#loading-div');
    let bestMatchTemplate = document.querySelector('#best-match-template');
    let resultRepoStatsTemplate = document.querySelector('#result-repo-stats-template');
    let repeatRepoMatchTemplate = document.querySelector('#repeat-repo-match-template');
    let loadedContentDiv = document.querySelector('#loaded-content');
    let bestMatchDiv = loadedContentDiv.querySelector('#best-match');
    let allOtherMatchesDiv = loadedContentDiv.querySelector('#all-other-matches');

    // Add truncate func to String
    String.prototype.truncate = String.prototype.truncate || 
        function ( n, useWordBoundary ){
        if (this.length <= n) { return this; }
        const subString = this.slice(0, n-1); // the original check
        return (useWordBoundary 
            ? subString.slice(0, subString.lastIndexOf(" ")) 
            : subString) + "&hellip;";
    };

    // Main function to make request and process response
    function process() {
        fetch(
            `/process`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                body: JSON.stringify({'query': query}),
            }
        ).then((response) => {
            response.json().then((data) => {
                console.log('Found repos:', data);

                // Replace content in top statement
                topStatement.innerHTML = topStatement.innerHTML.replace(
                    'Finding possible repositories for paper:',
                    `${data.length} potential repositories for:`
                );

                // Remove loading div
                loadingDiv.parentNode.removeChild(loadingDiv);

                // Add other matches content
                loadedContentDiv.querySelector('#all-other-matches-header').innerHTML = "Other Matches"

                // Catch error
                // TODO:

                // Process each repo found
                let templateClone;
                data.forEach((repo_data, index) => {
                    // Get the template for the best match
                    if (index == 0) {
                        templateClone = bestMatchTemplate.content.cloneNode(true);
                    // Get the repeatable template for all other matches
                    } else {
                        templateClone = repeatRepoMatchTemplate.content.cloneNode(true);
                    }

                    // Fill in basic details
                    templateClone.querySelector('.repo-name').innerHTML = repo_data['name'];
                    if (repo_data['description']) {
                        templateClone.querySelector('.repo-description').innerHTML = repo_data['description'].truncate(256, true);
                    };
                    templateClone.querySelector('.repo-link').href = repo_data['link'];

                    // Generate repo stats div
                    let resultRepoStatsClone = resultRepoStatsTemplate.content.cloneNode(true);
                    resultRepoStatsClone.querySelector('.star-count').innerHTML = repo_data['stars'];
                    resultRepoStatsClone.querySelector('.watcher-count').innerHTML = repo_data['watchers'];
                    resultRepoStatsClone.querySelector('.fork-count').innerHTML = repo_data['forks'];
                    resultRepoStatsClone.querySelector('.query-details').innerHTML = `found from keyword(s) from ${repo_data['data_from']} ('${repo_data['search_query']}')`;

                    // Attach repo stats to template clone
                    templateClone.querySelector('.repo-stats-container').appendChild(resultRepoStatsClone);

                    // Insert best match
                    if (index === 0) {
                        bestMatchDiv.appendChild(templateClone);
                    // Insert all others
                    } else {
                        allOtherMatchesDiv.appendChild(templateClone);
                    };
                });
            });
        });
    };

    // Run function
    process();
</script>

{% endblock %}